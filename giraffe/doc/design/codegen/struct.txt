=Struct=

Context

  repo
    the repository in use

  structInfo
    the struct typelib info

  structType
    extra information provided as part of codegen configuration indicating the
    struct type as follows:

      ValueRecord funcs
        The struct can be used like a value in C (and therefore also like a
        reference in C via a pointer).  The struct may own references to
        other data in which case a deep copy is required when copying the
        struct and references to other data must be cleared before freeing
        the struct itself.  To support this, `funcs` is as follows:

          SOME {copy, clear}
            The C function `copy` performs a deep copy and the C function
            `clear` removes all references to other data.

          NONE
            In the common case that the struct does not own references to
            other data, memcpy can be used to copy and there is no other
            referenced data to clear.

      Record {dup, free}
        The struct can only be used like a reference in C via a pointer, where
        C functions `dup` and `free` duplicate (or ref) and free (or unref)
        the struct.

      DisguisedRecord
        The struct is opaque and is just a pointer in C.


Placeholders

  StructName = GIBaseInfo.getName structInfo

  StructNamespace = GIBaseInfo.getNamespace structInfo

  StructCPrefix = GIRepository.getCPrefix repo <StructNamespace>

  optGetTypeSymbol = GIRegisteredTypeInfo.getTypeInit structInfo

  structSize = StructInfo.getSie structInfo  (TYPELIB only)


Conditions

  isGObject = "GObject" = StructNamespace


==Record signature==

signature <STRUCT_NAMESPACE>_<STRUCT_NAME>_RECORD =
  sig
                                                               -.
    include VALUE_RECORD                                        | structType is ValueRecord _
                                                               -'
                                                               -.
    include RECORD                                              | structType is Record _ | DisguisedRecord
                                                               -'
                                                               -.                -.
    type ('a, 'b) value_accessor_t                              |                 |
    val t : (t, t) value_accessor_t                             | isGObject       |
    val tOpt : (t option, t option) value_accessor_t            |                 |
                                                               -'                 | optGetTypeSymbol is SOME _
                                                               -.                 |
    val t : (t, t) ValueAccessor.t                              | not isGObject   |
    val tOpt : (t option, t option) ValueAccessor.t             |                 |
                                                               -'                -'
  end


==Record structure==

structure <StructNamespace><StructName>Record :>
  <STRUCT_NAMESPACE>_<STRUCT_NAME>_RECORD
                                                                          -.
    where type ('a, 'b) value_accessor_t = ('a, 'b) ValueAccessor.t        | isGObject
                                                                          -'
=
  struct
                                                                                                                -.
    structure Pointer = CPointerInternal                                                                         |
    type opt = Pointer.opt                                                                                       | structType is ValueRecord _ | Record _
    type non_opt = Pointer.non_opt                                                                               |
    type 'a p = 'a Pointer.p                                                                                     |
                                                                                                                -'
                                                                                                                -.
    val cPtr = Pointer.PolyML.cVal : non_opt p PolyMLFFI.conversion                                              |
                                                                                                                 |
    local                                                                                                        |
      open PolyMLFFI                                                                                             |
    in                                                                                                           |
                                                                    -.                    -.                     |
      val size_ =                                                    |                     |                     |
        call                                                         | using GIR           |                     |
          (getSymbol "giraffe_<struct_namespace>_<struct_name>_size")|                     |                     |
          (cVoid --> GSize.PolyML.cVal)                              |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
      val size_ = fn () => <structSize>                              | using TYPELIB       |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
      val memcpy_ =                                                  |                     |                     |
        call                                                         |                     |                     |
          (getSymbol "memcpy")                                       |                     |                     |
          (cPtr &&> cPtr &&> GSize.FFI.cVal --> cVoid)               |                     |                     |
                                                                     | funcs is NONE       |                     |
      val copy_ =                                                    |                     | structType is       |
        fn src & dest =>                                             |                     |  ValueRecord funcs  |
          memcpy_ (dest & src & size_ ())                            |                     |                     | Poly/ML only
                                                                     |                     |                     |
      val clear_ = Fn.ignore                                         |                     |                     | structType is ValueRecord _ | Record _
                                                                    -'                     |                     |
                                                                    -.                     |                     |
      val copy_ =                                                    |                     |                     |
        call                                                         |                     |                     |
          (getSymbol "<copy>")                                       |                     |                     |
          (cPtr &&> cPtr --> cVoid)                                  | funcs is            |                     |
                                                                     |  SOME {copy, clear} |                     |
      val clear_ =                                                   |                     |                     |
        call                                                         |                     |                     |
          (getSymbol "<clear>")                                      |                     |                     |
          (cPtr --> cVoid)                                           |                     |                     |
                                                                    -'                    -'                     |
                                                                                          -.                     |
      val dup_ =                                                                           |                     |
        call                                                                               |                     |
          (getSymbol "<dup>")                                                              |                     |
          (cPtr --> cPtr)                                                                  | structType is       |
                                                                                           |  Record {dup, free} |
      val free_ =                                                                          |                     |
        call                                                                               |                     |
          (getSymbol "<free>")                                                             |                     |
          (cPtr --> cVoid)                                                                 |                     |
                                                                                          -'                     |
    end                                                                                                          |
                                                                                                                -'
                                                                                          -.                    -.
                                                                    -.                     |                     |
    val size_ =                                                      |                     |                     |
      _import "giraffe_<struct_namespace>_<struct_name>_size"        | using GIR           |                     |
        : unit -> GSize.FFI.val_;                                    |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
    val size_ = fn () => <structSize>                                | using TYPELIB       |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
    val memcpy_ =                                                    |                     |                     |
      fn x1 & x2 & x3 =>                                             |                     |                     |
        (_import "memcpy" : non_opt p * non_opt p * GSize.FFI.val_ -> unit;)               |                     |
        (x1, x2, x3)                                                 |                     |                     |
                                                                     | funcs is NONE       | structType is       |
    val copy_ =                                                      |                     |  ValueRecord funcs  |
      fn src & dest =>                                               |                     |                     |
        memcpy_ (dest & src & size_ ())                              |                     |                     | MLton only
                                                                     |                     |                     |
    val clear_ = Fn.ignore                                           |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
    val copy_ =                                                      |                     |                     |
      fn x1 & x2 =>                                                  |                     |                     |
        (_import "<copy>" : non_opt p * non_opt p -> unit;)          | funcs is            |                     |
        (x1, x2)                                                     |  SOME {copy, clear} |                     |
                                                                     |                     |                     |
    val clear_ =                                                     |                     |                     |
      _import "<clear>" : non_opt p -> unit;                         |                     |                     |
                                                                    -'                    -'                     |
                                                                                          -.                     |
    val dup_ = _import "<dup>" : non_opt p -> non_opt p;                                   | structType is       |
                                                                                           |  Record {dup, free} |
    val free_ = _import "<free>" : non_opt p -> unit;                                      |                     |
                                                                                          -'                    -'
                                                                                          -.
    structure Record =                                                                     |
      BoxedValueRecord(                                                                    |
        structure Pointer = Pointer                                                        |
        type opt = opt                                                                     |
        type non_opt = non_opt                                                             | structType is ValueRecord _
        type 'a p = 'a p                                                                   |
        val copy_ = copy_                                                                  |
        val clear_ = clear_                                                                |
        val size_ = size_                                                                  |
      )                                                                                    |
                                                                                          -'
                                                                                          -.
    structure Record =                                                                     |
      BoxedRecord(                                                                         |
        structure Pointer = Pointer                                                        |
        type opt = opt                                                                     |
        type non_opt = non_opt                                                             | structType is Record _
        type 'a p = 'a p                                                                   |
        val dup_ = dup_                                                                    |
        val take_ = ignore                                                                 |
        val free_ = free_                                                                  |
      )                                                                                    |
                                                                                          -'
                                                                                          -.
    structure Record =                                                                     |
      PointerRecord(                                                                       | structType is DisguisedRecord
        val name = "<StructNamespace>.<StructName>"                                        |
      )                                                                                    |
                                                                                          -'
    open Record
                                                                            -.              -.
    local                                                                    |               |
      open PolyMLFFI                                                         |               |
    in                                                                       |               |
                                               -.                            |               |
      val getType_ =                            |                            |               |
        call                                    | getTypeSymbol <> "intern"  |               |
          (getSymbol "<getTypeSymbol>")         |                            | Poly/ML only  |
          (cVoid --> GObjectType.PolyML.cVal);  |                            |               |
                                               -'                            |               |
                                                                             |               |
      val getValue_ =                                                        |               |
        call                                                                 |               |
          (getSymbol "g_value_get_<valueType>")                              |               |
          (GObjectValueRecord.PolyML.cPtr --> PolyML.cPtr);                  |               |
                                                                             |               |
      val getOptValue_ =                                                     |               |
        call                                                                 |               |
          (getSymbol "g_value_get_<valueType>")                              |               |
          (GObjectValueRecord.PolyML.cPtr --> PolyML.cOptPtr);               |               |
                                                                             |               |
      val setValue_ =                                                        |               |
        call                                                                 |               |
          (getSymbol "g_value_set_<valueType>")                              |               |
          (GObjectValueRecord.PolyML.cPtr &&> PolyML.cPtr --> cVoid);        |               |
                                                                             |               |
      val setOptValue_ =                                                     |               |
        call                                                                 |               |
          (getSymbol "g_value_set_<valueType>")                              |               |
          (GObjectValueRecord.PolyML.cPtr &&> PolyML.cOptPtr --> cVoid);     |               |
    end                                                                      |               | optGetTypeSymbol
                                                                            -'               |  is SOME getTypeSymbol
                                               -.                           -.               |
    val getType_ =                              |                            |               |
      _import "<getTypeSymbol>" :               | getTypeSymbol <> "intern"  |               |
        unit -> GObjectType.FFI.val_;           |                            |               |
                                               -'                            |               |
                                                                             |               |
    val getValue_ =                                                          |               |
      _import "g_value_get_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p -> FFI.non_opt FFI.p;                       |               |
                                                                             |               |
    val getOptValue_ =                                                       |               |
      _import "g_value_get_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p -> unit FFI.p;                              | MLton only    |
                                                                             |               |
    val setValue_ =                                                          |               |
      _import "g_value_set_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p * FFI.non_opt FFI.p -> unit;                |               |
                                                                             |               |
    val setOptValue_ =                                                       |               |
      _import "g_value_set_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p * unit FFI.p -> unit;                       |               |
                                                                            -'               |
                                                                            -.               |
    type ('a, 'b) value_accessor_t = ('a, 'b) ValueAccessor.t                | isGObject     |
                                                                            -'               |
    val t =                                                                                  |
      ValueAccessor.C.createAccessor {                                                       |
                                                              -.                             |
        getType  = (I ---> GObjectType.FFI.fromVal) getType_,  | getTypeSymbol <> "intern"   |
                                                              -'                             |
                                                              -.                             |
        getType  = GObjectType.<valueType>,                    | getTypeSymbol = "intern"    |
                                                              -'                             |
        getValue = (I ---> FFI.fromPtr false) getValue_,                                     |
        setValue = (I &&&> FFI.withPtr ---> I) setValue_                                     |
      }                                                                                      |
    val tOpt =                                                                               |
      ValueAccessor.C.createAccessor {                                                       |
                                                              -.                             |
        getType  = (I ---> GObjectType.FFI.fromVal) getType_,  | getTypeSymbol <> "intern"   |
                                                              -'                             |
                                                              -.                             |
        getType  = GObjectType.<valueType>,                    | getTypeSymbol = "intern"    |
                                                              -'                             |
        getValue = (I ---> FFI.fromOptPtr false) getOptValue_,                               |
        setValue = (I &&&> FFI.withOptPtr ---> I) setOptValue_                               |
      }                                                                                      |
                                                                                            -'
  end


where


  valueType
    is defined as follows:

        variant
          if (StructNamespace, StructName) = ("GLib", "Variant")

        boxed
          otherwise


==Struct signature==

signature <STRUCT_NAMESPACE>_<STRUCT_NAME> =
  sig
    (* Local Types *)

    type t

    type <varlist[1]> <local_name[1]>

    ...

    type <varlist[N]> <local_name[N]>


    (* Functions *)
                                                          -.                           -. 
    val getType : unit -> <type>                           | getTypeSymbol <> "intern"  | optGetTypeSymbol is SOME getTypeSymbol
                                                          -'                           -'
    <FunctionSpec[1]>

    ...

    <FunctionSpec[M]>
  end


where


  type
    is defined as follows:

        GObject.Type.t
          if not isGObject

        type_t
          if isGObject


  localName[n], typeName[n], t[n], varlist[n]
    For n in 1 .. N

      <varlist[n]> <local_name[n]>

    is the <n>th element in the list of types referenced later in the
    signature that, for some InterfaceName and some var,
    has one of the following forms:

      <var> <interface_name>_class
      <var> <interface_name>_union
      <interface_name>_t

    where the corresponding global type has the form

      <StructNamespace>.<TypeName[n]>.<t[n]>


==Struct structure==

structure <StructNamespace><StructName> :>
  <STRUCT_NAMESPACE>_<STRUCT_NAME>
    where type t = <StructNamespace><StructName>Record.t

    where type <varlist[1]> <local_name[1]> = <varlist[1]> <StructNamespace><TypeName[1]>.<t[1]>

    ...

    where type <varlist[N]> <local_name[N]> = <varlist[N]> <StructNamespace><TypeName[N]>.<t[N]>
=
  struct
    (* Low-Level Functions *)

    local                                                                                               -.
      open PolyMLFFI                                                                                     |
    in                                                                                                   |
                                               -.                           -.                           |
      val getType_ =                            |                            |                           |
        call                                    | getTypeSymbol <> "intern"  | optGetTypeSymbol          |
          (getSymbol "<getTypeSymbol>")         |                            |  is SOME getTypeSymbol    |
          (cVoid --> GObjectType.PolyML.cVal);  |                            |                           |
                                               -'                           -'                           | Poly/ML only
                                                                                                         |
      <LowLevelFunction[1]>                                                                              |
                                                                                                         |
      ...                                                                                                |
                                                                                                         |
      <LowLevelFunction[M]>                                                                              |
    end                                                                                                 -'

                                               -.                           -.                          -.
    val getType_ =                              |                            | optGetTypeSymbol          |
      _import "<getTypeSymbol>" :               | getTypeSymbol <> "intern"  |  is SOME getTypeSymbol    |
        unit -> GObjectType.C.val_;             |                            |                           |
                                               -'                           -'                           |
                                                                                                         | MLton only
    <LowLevelFunction[1]>                                                                                |
                                                                                                         |
    ...                                                                                                  |
                                                                                                         |
    <LowLevelFunction[M]>                                                                               -'


    (* Local Types *)

    type t = <StructNamespace><StructName>Record.t

    type <varlist[1]> <local_name[1]> = <varlist[1]> <StructNamespace[1]><TypeName[1]>.<t[1]>

    ...

    type <varlist[N]> <local_name[N]> = <varlist[N]> <StructNamespace[N]><TypeName[N]>.<t[N]>


    (* High-Level Functions *)
                                                          -.                           -. 
    val getType = (I ---> GObjectType.C.fromVal) getType_  | getTypeSymbol <> "intern"  | optGetTypeSymbol is SOME getTypeSymbol
                                                          -'                           -'
    <HighLevelFunction[1]>

    ...

    <HighLevelFunction[M]>
  end


where


  localName[n], typeName[n], t[n], varlist[n] are the same as for the signature;


  ...
