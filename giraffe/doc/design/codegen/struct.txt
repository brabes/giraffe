=Struct=

Context

  repo
    the repository in use

  structInfo
    the struct typelib info


Placeholders

  StructName = GIBaseInfo.getName structInfo

  StructNamespace = GIBaseInfo.getNamespace structInfo

  StructCPrefix = GIRepository.getCPrefix repo <StructNamespace>

  optGetTypeSymbol = GIRegisteredTypeInfo.getTypeInit structInfo


Conditions

  isGObject = "GObject" = StructNamespace


==Record signature==



==Record structure==



==Struct signature==

signature <STRUCT_NAMESPACE>_<STRUCT_NAME> =
  sig
    (* Local Types *)

    type t

    type <varlist[1]> <local_name[1]>

    ...

    type <varlist[N]> <local_name[N]>


    (* Functions *)
                                                              -.
    val getType : unit -> <type>                               | optGetTypeSymbol is SOME _
                                                              -'
    <FunctionSpec[1]>

    ...

    <FunctionSpec[M]>
  end


where


  type
    is defined as follows:

        GObject.Type.t
          if not isGObject

        type_t
          if isGObject


  localName[n], typeName[n], t[n], varlist[n]
    For n in 1 .. N

      <varlist[n]> <local_name[n]>

    is the <n>th element in the list of types referenced later in the
    signature that, for some InterfaceName and some var,
    has one of the following forms:

      <var> <interface_name>_class
      <var> <interface_name>_union
      <interface_name>_t

    where the corresponding global type has the form

      <StructNamespace>.<TypeName[n]>.<t[n]>


==Struct structure==

structure <StructNamespace><StructName> :>
  <STRUCT_NAMESPACE>_<STRUCT_NAME>
    where type t = <StructNamespace><StructName>Record.t

    where type <varlist[1]> <local_name[1]> = <varlist[1]> <StructNamespace><TypeName[1]>.<t[1]>

    ...

    where type <varlist[N]> <local_name[N]> = <varlist[N]> <StructNamespace><TypeName[N]>.<t[N]>
=
  struct
    (* Low-Level Functions *)

    local                                                                                 -.
      open PolyMLFFI                                                                       |
    in                                                                                     |
                                                              -.                           |
      val getType_ =                                           |                           |
        call                                                   | optGetTypeSymbol          |
          (getSymbol "<getTypeSymbol>")                        |  is SOME getTypeSymbol    |
          (PolyMLFFI.cVoid --> GObjectType.PolyML.cVal);       |                           |
                                                              -'                           | Poly/ML only
                                                                                           |
      <LowLevelFunction[1]>                                                                |
                                                                                           |
      ...                                                                                  |
                                                                                           |
      <LowLevelFunction[M]>                                                                |
    end                                                                                   -'

                                                              -.                          -.
    val getType_ =                                             | optGetTypeSymbol          |
      _import "<getTypeSymbol>" : unit -> GObjectType.C.val_;  |  is SOME getTypeSymbol    |
                                                              -'                           |
                                                                                           | MLton only
    <LowLevelFunction[1]>                                                                  |
                                                                                           |
    ...                                                                                    |
                                                                                           |
    <LowLevelFunction[M]>                                                                 -'


    (* Local Types *)

    type t = <StructNamespace><StructName>Record.t

    type <varlist[1]> <local_name[1]> = <varlist[1]> <StructNamespace[1]><TypeName[1]>.<t[1]>

    ...

    type <varlist[N]> <local_name[N]> = <varlist[N]> <StructNamespace[N]><TypeName[N]>.<t[N]>


    (* High-Level Functions *)
                                                              -. 
    val getType = (I ---> GObjectType.C.fromVal) getType_      | optGetTypeSymbol is SOME _
                                                              -'
    <HighLevelFunction[1]>

    ...

    <HighLevelFunction[M]>
  end


where


  localName[n], typeName[n], t[n], varlist[n] are the same as for the signature;


  ...
