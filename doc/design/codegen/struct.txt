=Struct=

Context

  repo
    the repository in use

  structInfo
    the struct typelib info

  structType
    extra information provided as part of codegen configuration indicating the
    struct type as follows:

      ValueRecord funcs
        The struct can be used like a value in C (and therefore also like a
        reference in C via a pointer).  The struct may own references to
        other data in which case a deep copy is required when copying the
        struct and references to other data must be cleared before freeing
        the struct itself.  To support this, `funcs` is as follows:

          Deep {copy, clear}
            The C function `copy` performs a deep copy and the C function
            `clear` removes all references to other data.

          Flat
            In the common case that the struct does not own references to
            other data, memcpy can be used to copy and there is no other
            referenced data to clear.

      Record funcs
        The struct can only be used like a reference in C via a pointer, where
        the functions to duplicate (or ref) and free (or unref) the struct are
        determined by `funcs` as follows:

          Boxed
            The C functions `g_boxed_copy` and `g_boxed_free` are used to
            duplicate (or ref) and free (or unref) the struct respectively.

          NonBoxed {dup, free}
            The C functions `dup` and `free` is used to free are used to
            duplicate (or ref) and free (or unref) the struct respectively.

      DisguisedRecord
        The struct is disguised and is just a pointer in C.

      UnionRecord (parentUnionNamespace, parentUnionName, fieldName)
        The struct is the field of a union and is internally the same
        as the union.


Placeholders

  StructName = GIBaseInfo.getName structInfo

  StructNamespace = GIBaseInfo.getNamespace structInfo

  StructCPrefix = GIRepository.getCPrefix repo <StructNamespace>

  optGetTypeSymbol = GIRepository.RegisteredTypeInfo.getTypeInit structInfo

  optStructCType = GIRepository.RegisteredTypeInfo.getCType structInfo

  structSize = StructInfo.getSie structInfo  (TYPELIB only)


Conditions

  isGObject = "GObject" = StructNamespace


==Record signature==

signature <STRUCT_NAMESPACE>_<STRUCT_NAME>_RECORD =
  sig
                                                                                 -.
    include VALUE_RECORD                                                          | structType is ValueRecord _
                                                                                 -'
                                                                                 -.
    include RECORD                                                                | structType is Record _ | DisguisedRecord
                                                                                 -'
                                                                                 -.
    type <field_name>                                                             |
                                      -.                                          |
    type 'a <parent_union_name>_union  | StructNamespace = ParentUnionNamespace   |
    include RECORD                     |                                          |
      where type t = <field_name> <parent_union_name>_union                       | structType is UnionRecord ("<ParentUnionNamespace>", "<ParentUnionName>", "<FieldName>")
                                      -'                                          |
                                      -.                                          |
    include RECORD                     | StructNamespace <> ParentUnionNamespace  |
      where type t = <field_name> <ParentUnionNamespace><ParentUnionName>.union   |
                                      -'                                         -'
                                                                                 -.
    val t : t ValueAccessor.t                                                     | optGetTypeSymbol is SOME _
    val tOpt : t option ValueAccessor.t                                           |
                                                                                 -'
  end


==Record structure==

structure <StructNamespace><StructName>Record :>
  <STRUCT_NAMESPACE>_<STRUCT_NAME>_RECORD
                                                               -.                                               -.
    where                                                       |                                                |
      type 'a <parent_union_name>_union =                       | StructNamespace = ParentUnionNamespace         |
        'a <ParentUnionNamespace><ParentUnionName>.union        |                                                | structType is
                                                               -'                                                |  UnionRecord ("<ParentUnionNamespace>", "<ParentUnionName>", "<FieldName>")
    where type C.opt = <ParentUnionNamespace><ParentUnionName>.C.opt                                             |
    where type C.non_opt = <ParentUnionNamespace><ParentUnionName>.C.non_opt                                     |
    where type 'a C.p = 'a <ParentUnionNamespace><ParentUnionName>.C.p =                                         |
                                                                                                                -'
=
  struct
                                                                                                                -.
    structure Pointer = CPointer(GMemory)                                                                        |
    type opt = Pointer.opt                                                                                       | structType is ValueRecord _ | Record _
    type non_opt = Pointer.non_opt                                                                               |
    type 'a p = 'a Pointer.p                                                                                     |
                                                                                           -.                    |
    val cPtr = Pointer.PolyML.cVal : non_opt p PolyMLFFI.conversion                         | Poly/ML only       |
                                                                                           -'                   -'
                                                               -.                                               -.
    type 'a <parent_union_name>_union =                         | StructNamespace = ParentUnionNamespace         | structType is
      'a <ParentUnionNamespace><ParentUnionName>.union          |                                                |  UnionRecord ("<ParentUnionNamespace>", "<ParentUnionName>", "<FieldName>")
                                                               -'                                                |
    type <field_name> = unit                                                                                     |
    type t = <field_name> <ParentUnionNamespace><ParentUnionName>.union                                          |
                                                                                                                -'
                                                 -.             -.                         -.
    local                                         |              |                           |
      open PolyMLFFI                              |              |                           |
    in                                            |              |                           |
      val getType_ =                              |              |                           |
        call                                      | Poly/ML only |                           |
          (<getFunctionSymbol> "<getTypeSymbol>") |              |                           |
          (cVoid --> GObjectType.PolyML.cVal);    |              |                           |
    end                                           |              | getTypeSymbol <> "intern" |
                                                 -'              |                           | optGetTypeSymbol
                                                 -.              |                           |  is SOME getTypeSymbol
    val getType_ =                                |              |                           |
      _import "<getTypeSymbol>" :                 | MLton only   |                           |
        unit -> GObjectType.FFI.val_;             |              |                           |
                                                 -'              |                           |
                                                                 |                           |
    val getType = (I ---> GObjectType.FFI.fromVal) getType_      |                           |
                                                                -'                           |
                                                                -.                           |
    val getType = GObjectType.<valueType>                        | getTypeSymbol = "intern"  |
                                                                -'                          -'
                                                                                                                -.
    local                                                                                                        |
      open PolyMLFFI                                                                                             |
    in                                                                                                           |
                                                                    -.                    -.                     |
      val size_ =                                                    |                     |                     |
        call                                                         | using GIR           |                     |
          (<getFunctionSymbol> "giraffe_<struct_namespace>_<struct_name>_size")            |                     |
          (cVoid --> GSize.PolyML.cVal)                              |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
      val size_ = fn () => <structSize>                              | using TYPELIB       |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
      val memcpy_ =                                                  |                     |                     |
        call                                                         |                     |                     |
          (<getFunctionSymbol> "memcpy")                             |                     |                     |
          (cPtr &&> cPtr &&> GSize.FFI.cVal --> cVoid)               |                     |                     |
                                                                     | funcs is Flat       |                     |
      val copy_ =                                                    |                     | structType is       |
        fn src & dest =>                                             |                     |  ValueRecord funcs  |
          memcpy_ (dest & src & size_ ())                            |                     |                     | Poly/ML only
                                                                     |                     |                     |
      val clear_ = Fn.ignore                                         |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
      val copy_ =                                                    |                     |                     |
        call                                                         |                     |                     |
          (<getFunctionSymbol> "<copy>")                             |                     |                     |
          (cPtr &&> cPtr --> cVoid)                                  | funcs is            |                     |
                                                                     |  Deep {copy, clear} |                     |
      val clear_ =                                                   |                     |                     |
        call                                                         |                     |                     |
          (<getFunctionSymbol> "<clear>")                            |                     |                     |
          (cPtr --> cVoid)                                           |                     |                     |
                                                                    -'                    -'                     |
                                                                    -.                    -.                     |
      val dup_ =                                                     | funcs is Boxed      |                     |
        let                                                          |                     |                     |
          val boxedFun_ =                                            |                     |                     |
            call                                                     | EITHER              |                     |
              (<getFunctionSymbol> "g_boxed_copy")                   |                     |                     |
              (GObjectType.PolyML.cVal &&> cPtr --> cPtr)            | optGetTypeSymbol is |                     |
        in                                                           |  SOME getTypeSymbol |                     |
          fn x1 => boxedFun_ (getType_ () & x1)                      |                     |                     |
        end                                                          | getTypeSymbol       |                     |
                                                                     |  <> "intern"        |                     |
      val free_ =                                                    |                     |                     |
        let                                                          | OR                  |                     |
          val boxedFun_ =                                            |                     |                     |
            call                                                     | raise Fail          |                     |
              (<getFunctionSymbol> "g_boxed_free")                   |                     |                     |
              (GObjectType.PolyML.cVal &&> cPtr --> cVoid)           |                     |                     |
        in                                                           |                     |                     |
          fn x1 => boxedFun_ (getType_ () & x1)                      |                     |                     |
        end                                                          |                     |                     |
                                                                    -'                     | structType is       |
                                                                    -.                     |  Record funcs       |
      val dup_ =                                                     |                     |                     |
        call                                                         |                     |                     |
          (<getFunctionSymbol> "<dup>")                              |                     |                     |
          (cPtr --> cPtr)                                            | funcs is            |                     |
                                                                     |  NonBoxed           |                     |
      val free_ =                                                    |    {dup, free}      |                     |
        call                                                         |                     |                     |
          (<getFunctionSymbol> "<free>")                             |                     |                     |
          (cPtr --> cVoid)                                           |                     |                     |
                                                                    -'                    -'                     |
    end                                                                                                          |
                                                                                                                -'
                                                                    -.                    -.                    -.
    val size_ =                                                      |                     |                     |
      _import "giraffe_<struct_namespace>_<struct_name>_size" pure   | using GIR           |                     |
        : unit -> GSize.FFI.val_;                                    |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
    val size_ = fn () => <structSize>                                | using TYPELIB       |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
    val memcpy_ =                                                    |                     |                     |
      fn x1 & x2 & x3 =>                                             |                     |                     |
        (_import "memcpy" : non_opt p * non_opt p * GSize.FFI.val_ -> unit;)               |                     |
          (x1, x2, x3)                                               |                     |                     |
                                                                     | funcs is Flat       | structType is       |
    val copy_ =                                                      |                     |  ValueRecord funcs  |
      fn src & dest =>                                               |                     |                     |
        memcpy_ (dest & src & size_ ())                              |                     |                     | MLton only
                                                                     |                     |                     |
    val clear_ = Fn.ignore                                           |                     |                     |
                                                                    -'                     |                     |
                                                                    -.                     |                     |
    val copy_ =                                                      |                     |                     |
      fn x1 & x2 =>                                                  |                     |                     |
        (_import "<copy>" : non_opt p * non_opt p -> unit;)          | funcs is            |                     |
          (x1, x2)                                                   |  Deep {copy, clear} |                     |
                                                                     |                     |                     |
    val clear_ =                                                     |                     |                     |
      _import "<clear>" : non_opt p -> unit;                         |                     |                     |
                                                                    -'                    -'                     |
                                                                    -.                    -.                     |
    val dup_ =                                                       |                     |                     |
      let                                                            | funcs is Boxed      |                     |
        val boxedFun_ =                                              |                     |                     |
          fn x1 & x2 =>                                              |                     |                     |
            (_import "g_boxed_copy" :                                | EITHER              |                     |
              GObjectType.FFI.val_ * non_opt p -> non_opt p;)        |                     |                     |
              (x1, x2)                                               | optGetTypeSymbol is |                     |
      in                                                             |  SOME getTypeSymbol |                     |
        fn x1 => boxedFun_ (getType_ () & x1)                        |                     |                     |
      end                                                            | getTypeSymbol       |                     |
                                                                     |  <> "intern"        |                     |
    val free_ =                                                      |                     |                     |
      let                                                            | OR                  |                     |
        val boxedFun_ =                                              |                     |                     |
          fn x1 & x2 =>                                              | raise Fail          |                     |
            (_import "g_boxed_free" :                                |                     |                     |
              GObjectType.FFI.val_ * non_opt p -> non_opt p;)        |                     |                     |
              (x1, x2)                                               |                     |                     |
      in                                                             |                     |                     |
        fn x1 => boxedFun_ (getType_ () & x1)                        |                     |                     |
      end                                                            |                     |                     |
                                                                    -'                     | structType is       |
                                                                    -.                     |  Record funcs       |
    val dup_ = _import "<dup>" : non_opt p -> non_opt p;             | funcs is            |                     |
                                                                     |  NonBoxed           |                     |
    val free_ = _import "<free>" : non_opt p -> unit;                |    {dup, free}      |                     |
                                                                    -'                    -'                    -'
                                                                                          -.
    structure Record =                                                                     |
      BoxedValueRecord(                                                                    |
        structure Pointer = Pointer                                                        |
        type opt = opt                                                                     |
        type non_opt = non_opt                                                             |
        type 'a p = 'a p                                                                   | structType is ValueRecord _
        val copy_ = copy_                                                                  |
        val clear_ = clear_                                                                |
        val size_ = size_                                                                  |
        val getTypeName = <getTypeName>                                                    |
      )                                                                                    |
                                                                                          -'
                                                                                          -.
    structure Record =                                                                     |
      BoxedRecord(                                                                         |
        structure Pointer = Pointer                                                        |
        type opt = opt                                                                     |
        type non_opt = non_opt                                                             |
        type 'a p = 'a p                                                                   | structType is Record _
        val dup_ = dup_                                                                    |
        val take_ = ignore                                                                 |
        val free_ = free_                                                                  |
        val getTypeName = <getTypeName>                                                    |
      )                                                                                    |
                                                                                          -'
                                                                                          -.
    structure Record =                                                                     |
      PointerRecord(                                                                       | structType is DisguisedRecord
        val name = "<StructNamespace>.<StructName>"                                        |
      )                                                                                    |
                                                                                          -'
                                                                                          -.
    structure Record = <ParentUnionNamespace><ParentUnionName>                             | structType is
                                                                                          -'  UnionRecord ("<ParentUnionNamespace>", "<ParentUnionName>", _)
    open Record
                                                                            -.              -.
    local                                                                    |               |
      open PolyMLFFI                                                         |               |
    in                                                                       |               |
      val getValue_ =                                                        |               |
        call                                                                 |               |
          (<getFunctionSymbol> "g_value_get_<valueType>")                    |               |
          (GObjectValueRecord.PolyML.cPtr --> PolyML.cPtr);                  |               |
                                                                             |               |
      val getOptValue_ =                                                     |               |
        call                                                                 |               |
          (<getFunctionSymbol> "g_value_get_<valueType>")                    | Poly/ML only  |
          (GObjectValueRecord.PolyML.cPtr --> PolyML.cOptPtr);               |               |
                                                                             |               |
      val setValue_ =                                                        |               |
        call                                                                 |               |
          (<getFunctionSymbol> "g_value_set_<valueType>")                    |               |
          (GObjectValueRecord.PolyML.cPtr &&> PolyML.cPtr --> cVoid);        |               |
                                                                             |               |
      val setOptValue_ =                                                     |               |
        call                                                                 |               |
          (<getFunctionSymbol> "g_value_set_<valueType>")                    |               |
          (GObjectValueRecord.PolyML.cPtr &&> PolyML.cOptPtr --> cVoid);     |               |
    end                                                                      |               | optGetTypeSymbol
                                                                            -'               |  is SOME _
                                                                            -.               |
    val getValue_ =                                                          |               |
      _import "g_value_get_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p -> FFI.non_opt FFI.p;                       |               |
                                                                             |               |
    val getOptValue_ =                                                       |               |
      _import "g_value_get_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p -> unit FFI.p;                              | MLton only    |
                                                                             |               |
    val setValue_ =                                                          |               |
      _import "g_value_set_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p * FFI.non_opt FFI.p -> unit;                |               |
                                                                             |               |
    val setOptValue_ =                                                       |               |
      _import "g_value_set_<valueType>" :                                    |               |
        GObjectValueRecord.FFI.p * unit FFI.p -> unit;                       |               |
                                                                            -'               |
    val t =                                                                                  |
      ValueAccessor.C.createAccessor {                                                       |
        getType  = getType,                                                                  |
        getValue = (I ---> FFI.fromPtr false) getValue_,                                     |
        setValue = (I &&&> FFI.withPtr false ---> I) setValue_                               |
      }                                                                                      |
    val tOpt =                                                                               |
      ValueAccessor.C.createAccessor {                                                       |
        getType  = getType,                                                                  |
        getValue = (I ---> FFI.fromOptPtr false) getOptValue_,                               |
        setValue = (I &&&> FFI.withOptPtr false ---> I) setOptValue_                         |
      }                                                                                      |
                                                                                            -'
  end


where


  getFunctionSymbol
    is
      externalFunctionSymbol
        if generating from a GIR file

      getSymbol
        if generating from a TYPELIB file


  valueType
    is defined as follows:

        variant
          if (StructNamespace, StructName) = ("GLib", "Variant")

        boxed
          otherwise


  getTypeName
    is defined as follows:

        GObjectType.name o getType
          if optGetTypeSymbol is SOME _

        fn () => "<StructCType>"
          if optGetTypeSymbol is NONE and optStructCType is SOME StructCType

        <raise Fail>
          if optGetTypeSymbol is NONE and optStructCType is NONE


==Struct signature==

signature <STRUCT_NAMESPACE>_<STRUCT_NAME> =
  sig
    (* Local Types *)

    type t

    type <varlist[1]> <local_name[1]>

    ...

    type <varlist[N]> <local_name[N]>


    (* Fields *)

    <FieldSpec[1]>

    ...

    <FieldSpec[F]>


    (* Functions *)
                                                          -.                           -. 
    val getType : unit -> <type>                           | getTypeSymbol <> "intern"  | optGetTypeSymbol is SOME getTypeSymbol
                                                          -'                           -'
                                                          -.
    val new :                                              |
      {                                                    |
        <fieldName[1]> : <fieldType[1](false)>,            |
        ...                                                | structType is ValueRecord _
        <fieldName[F]> : <fieldType[F](false)>             |
      }                                                    |
       -> t                                                |
                                                          -'
    <FunctionSpec[1]>

    ...

    <FunctionSpec[M]>
  end


where


  type
    is defined as follows:

        GObject.Type.t
          if not isGObject

        type_t
          if isGObject


  localName[n], typeName[n], t[n], varlist[n]
    For n in 1 .. N

      <varlist[n]> <local_name[n]>

    is the <n>th element in the list of types referenced later in the
    signature that, for some InterfaceName and some var,
    has one of the following forms:

      <var> <interface_name>_class
      <var> <interface_name>_union
      <interface_name>_t

    where the corresponding global type has the form

      <StructNamespace>.<TypeName[n]>.<t[n]>


==Struct structure==

structure <StructNamespace><StructName> :>
  <STRUCT_NAMESPACE>_<STRUCT_NAME>
    where type t = <StructNamespace><StructName>Record.t

    where type <varlist[1]> <local_name[1]> = <varlist[1]> <StructNamespace><TypeName[1]>.<t[1]>

    ...

    where type <varlist[N]> <local_name[N]> = <varlist[N]> <StructNamespace><TypeName[N]>.<t[N]>
=
  struct
    (* Low-Level Functions *)
                                                                                                        -.
    local                                                                                                |
      open PolyMLFFI                                                                                     |
    in                                                                                                   |
                                               -.                           -.                           |
      val getType_ =                            |                            |                           |
        call                                    | getTypeSymbol <> "intern"  | optGetTypeSymbol          |
          (<getFunctionSymbol> "<getTypeSymbol>")                            |  is SOME getTypeSymbol    |
          (cVoid --> GObjectType.PolyML.cVal);  |                            |                           |
                                               -'                           -'                           |
                                                                                                         |
      <LowLevelFunction[1]>                                                                              | Poly/ML only
                                                                                                         |
      ...                                                                                                |
                                                                                                         |
      <LowLevelFunction[M]>                                                                              |
                                                                                                         |
      <LowLevelFieldOffsetFunction[1]>                                                                   |
                                                                                                         |
      ...                                                                                                |
                                                                                                         |
      <LowLevelFieldOffsetFunction[F]>                                                                   |
    end                                                                                                  |
                                                                                                        -'
                                               -.                           -.                          -.
    val getType_ =                              |                            | optGetTypeSymbol          |
      _import "<getTypeSymbol>" :               | getTypeSymbol <> "intern"  |  is SOME getTypeSymbol    |
        unit -> GObjectType.C.val_;             |                            |                           |
                                               -'                           -'                           |
                                                                                                         |
    <LowLevelFunction[1]>                                                                                |
                                                                                                         |
    ...                                                                                                  | MLton only
                                                                                                         |
    <LowLevelFunction[M]>                                                                                |
                                                                                                         |
    <LowLevelFieldOffsetFunction[1]>                                                                     |
                                                                                                         |
    ...                                                                                                  |
                                                                                                         |
    <LowLevelFieldOffsetFunction[F]>                                                                     |
                                                                                                        -'


    (* Local Types *)

    type t = <StructNamespace><StructName>Record.t

    type <varlist[1]> <local_name[1]> = <varlist[1]> <StructNamespace[1]><TypeName[1]>.<t[1]>

    ...

    type <varlist[N]> <local_name[N]> = <varlist[N]> <StructNamespace[N]><TypeName[N]>.<t[N]>


    (* Fields *)

    <FieldStructure[1]>

    ...

    <FieldStructure[F]>

    <FieldAccessor[1]>

    ...

    <FieldAccessor[F]>


    (* High-Level Functions *)
                                                          -.                           -. 
    val getType = (I ---> GObjectType.C.fromVal) getType_  | getTypeSymbol <> "intern"  | optGetTypeSymbol is SOME getTypeSymbol
                                                          -'                           -'
                                                                                       -. 
    fun new                                                                             |
      {                                                                                 |
        <fieldId[1]>,                                                                   |
        ...                                                                             |
        <fieldId[F]>                                                                    |
      } =                                                                               |
      let                                                                               |
        fun init_ p =                                                                   |
          let                                                                           |
            val () = <FieldName[1]>Field.C.set <fieldId[1]> p                           |
            ...                                                                         |
            val () = <FieldName[F]>Field.C.set <fieldId[F]> p                           |
          in                                                                            | structType is ValueRecord _
            ()                                                                          |
          end                                                                           |
        val retVal & () =                                                               |
          (                                                                             |
            <StructNamespace><StructName>Record.FFI.withNewPtr                          |
             ---> <StructNamespace><StructName>Record.FFI.fromPtr true && I             |
          )                                                                             |
            init_                                                                       |
            ()                                                                          |
      in                                                                                |
        retVal                                                                          |
      end                                                                               |
                                                                                       -'
    <HighLevelFunction[1]>

    ...

    <HighLevelFunction[M]>
  end


where


  getFunctionSymbol
    is
      externalFunctionSymbol
        if generating from a GIR file

      getSymbol
        if generating from a TYPELIB file


  localName[n], typeName[n], t[n], varlist[n] are the same as for the signature;


  ...
